name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  # ─── Gate: CI must pass before deploy ────────────────────────────────────
  ci:
    name: CI Gate
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read

  # ─── Determine environment ───────────────────────────────────────────────
  resolve-env:
    name: Resolve Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
          fi

  # ─── Deploy backend (CDK) ───────────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend (${{ needs.resolve-env.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [ci, resolve-env]
    timeout-minutes: 30
    environment: ${{ needs.resolve-env.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703a7f0b4fee19bcbac4b21f62 # v4.1.0
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: CDK Bootstrap (if needed)
        working-directory: packages/infra
        run: npx cdk bootstrap -c environment=${{ needs.resolve-env.outputs.environment }}

      - name: CDK Deploy
        working-directory: packages/infra
        env:
          PAYHERE_MERCHANT_ID: ${{ secrets.PAYHERE_MERCHANT_ID }}
          PAYHERE_MERCHANT_SECRET: ${{ secrets.PAYHERE_MERCHANT_SECRET }}
        run: |
          npx cdk deploy --all \
            --require-approval never \
            -c environment=${{ needs.resolve-env.outputs.environment }} \
            --outputs-file cdk-outputs.json

      - name: Upload CDK outputs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cdk-outputs-${{ needs.resolve-env.outputs.environment }}
          path: packages/infra/cdk-outputs.json
          retention-days: 30

  # ─── Deploy dashboard (S3 + CloudFront) ─────────────────────────────────
  deploy-dashboard:
    name: Deploy Dashboard (${{ needs.resolve-env.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [deploy-backend, resolve-env]
    timeout-minutes: 15
    environment: ${{ needs.resolve-env.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703a7f0b4fee19bcbac4b21f62 # v4.1.0
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download CDK outputs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: cdk-outputs-${{ needs.resolve-env.outputs.environment }}
          path: packages/infra/

      - name: Extract API URL from CDK outputs
        id: cdk
        run: |
          API_URL=$(cat packages/infra/cdk-outputs.json | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for stack in data.values():
            for key, val in stack.items():
              if 'apiurl' in key.lower() or 'ApiUrl' in key:
                print(val)
                sys.exit(0)
          print('http://localhost:3000')
          ")
          echo "api_url=$API_URL" >> "$GITHUB_OUTPUT"

      - name: Build dashboard
        working-directory: packages/dashboard
        env:
          VITE_API_URL: ${{ steps.cdk.outputs.api_url }}
          VITE_COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}
        run: pnpm build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy to S3
        run: |
          aws s3 sync packages/dashboard/dist/ \
            s3://${{ vars.DASHBOARD_S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          aws s3 cp packages/dashboard/dist/index.html \
            s3://${{ vars.DASHBOARD_S3_BUCKET }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        if: vars.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  # ─── Post-deploy verification ───────────────────────────────────────────
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-dashboard, resolve-env]
    timeout-minutes: 5
    environment: ${{ needs.resolve-env.outputs.environment }}

    steps:
      - name: Download CDK outputs
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: cdk-outputs-${{ needs.resolve-env.outputs.environment }}

      - name: Health check API
        run: |
          API_URL=$(cat cdk-outputs.json | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for stack in data.values():
            for key, val in stack.items():
              if 'apiurl' in key.lower() or 'ApiUrl' in key:
                print(val)
                sys.exit(0)
          ")

          if [ -z "$API_URL" ]; then
            echo "⚠️  No API URL found in CDK outputs — skipping health check"
            exit 0
          fi

          echo "Checking API health at $API_URL"
          for i in 1 2 3; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}" || true)
            echo "Attempt $i: HTTP $STATUS"
            if [ "$STATUS" = "200" ] || [ "$STATUS" = "403" ]; then
              echo "✅ API is reachable"
              exit 0
            fi
            sleep 5
          done
          echo "⚠️  API health check inconclusive (may require auth)"
